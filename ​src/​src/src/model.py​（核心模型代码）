import torch
import torch.nn as nn
import torch.nn.functional as F

class STGNNModel(nn.Module):
    """
    Spatio-Temporal Graph Neural Network for Hand Injury Prediction
    """
    def __init__(self, input_dim=18, hidden_dim=64, output_dim=1, num_heads=4):
        super().__init__()
        
        # Spatial Graph Attention Layer
        self.spatial_attention = nn.MultiheadAttention(
            embed_dim=hidden_dim, 
            num_heads=num_heads,
            dropout=0.2
        )
        
        # Temporal Convolutional Layer
        self.temporal_conv = nn.Conv1d(
            in_channels=hidden_dim, 
            out_channels=hidden_dim, 
            kernel_size=3, 
            padding=1
        )
        
        # Prediction Head
        self.predictor = nn.Sequential(
            nn.Linear(hidden_dim, 32),
            nn.ReLU(),
            nn.Dropout(0.3),
            nn.Linear(32, output_dim)
        )
        
    def forward(self, x, adj_matrix=None):
        # x shape: (batch_size, seq_len, num_nodes, input_dim)
        batch_size, seq_len, num_nodes, input_dim = x.shape
        
        # Spatial encoding
        spatial_features = x.mean(dim=1)  # Aggregate temporal dimension
        spatial_features = self.spatial_attention(
            spatial_features, spatial_features, spatial_features
        )[0]
        
        # Temporal encoding
        temporal_features = self.temporal_conv(
            spatial_features.transpose(1, 2)
        ).transpose(1, 2)
        
        # Prediction
        output = self.predictor(temporal_features.mean(dim=1))
        return output

def main():
    """Example usage"""
    model = STGNNModel()
    print(f"Model created with {sum(p.numel() for p in model.parameters()):,} parameters")
    
    # Test with sample data
    sample_input = torch.randn(2, 12, 14, 18)  # (batch, seq_len, nodes, features)
    sample_output = model(sample_input)
    print(f"Input shape: {sample_input.shape}")
    print(f"Output shape: {sample_output.shape}")

if __name__ == "__main__":
    main()
